<script>
const weights = { exam1:10, exam2:10, exam3:10, final:25, psets:10, practice:5, participation:5, presentation:5, lab:20 };

function showBox(id){
  document.getElementById('gradescopeBox').style.display='none';
  document.getElementById('sakaiBox').style.display='none';
  document.getElementById(id).style.display='block';
}

document.getElementById('showGradescope').addEventListener('click',()=>showBox('gradescopeBox'));
document.getElementById('showSakai').addEventListener('click',()=>showBox('sakaiBox'));

function highlightGlow(){
  const t=document.getElementById('gradeTable');
  t.classList.add('glow');
  setTimeout(()=>t.classList.remove('glow'),1500);
}

function calculateTotals(categorized=null){
  let totalWeighted=0;
  for(const key in weights){
    let avg=0;
    if(categorized&&categorized[key]&&categorized[key].length){
      const arr=categorized[key];
      const totalEarned=arr.reduce((a,b)=>a+b.earned,0);
      const totalMax=arr.reduce((a,b)=>a+b.max,0);
      avg=totalMax>0?(totalEarned/totalMax)*100:0;
      document.getElementById(key).textContent=avg.toFixed(2);
    } else {
      avg=parseFloat(document.getElementById(key).textContent)||0;
    }
    const pts=(avg*weights[key])/100;
    document.getElementById(key+'_pts').textContent=pts.toFixed(2);
    totalWeighted+=pts;
  }
  document.getElementById('results').textContent=`Current Overall Grade: ${totalWeighted.toFixed(2)}%`;
  highlightGlow();
}

function classifyAssignments(scores){
  const c={exam1:[],exam2:[],exam3:[],final:[],psets:[],practice:[],participation:[],presentation:[],lab:[]};
  for(const s of scores){
    const n=s.name.toLowerCase();
    if(n.includes('exam 1'))c.exam1.push(s);
    else if(n.includes('exam 2'))c.exam2.push(s);
    else if(n.includes('exam 3'))c.exam3.push(s);
    else if(n.includes('final'))c.final.push(s);
    else if(n.includes('pset')||n.includes('problem set'))c.psets.push(s);
    else if(n.includes('practice')||n.includes('class'))c.practice.push(s);
    else if(n.includes('participation'))c.participation.push(s);
    else if(n.includes('presentation'))c.presentation.push(s);
    else if(n.includes('lab')||n.includes('quiz'))c.lab.push(s);
  }
  return c;
}

function parseGradescope(){
  let t=document.getElementById('gradescopeText').value;
  if(!t.trim())return alert('Paste Gradescope text first.');
  t=t.replace(/\n(?=\d+\.?\d*\s*\/\s*\d+)/g,' ');
  const lines=t.split(/\n+/);
  const scores=[];
  const r=/(.*?)\s*(\d+(?:\.\d+)?)\s*\/\s*(\d+(?:\.\d+)?)/;
  for(const l of lines){
    const m=l.match(r);
    if(m)scores.push({name:m[1].trim(),earned:parseFloat(m[2]),max:parseFloat(m[3])});
  }
  if(!scores.length)return alert('No scores found.');
  const cat=classifyAssignments(scores);
  calculateTotals(cat);
}

// ✅ FINAL SAKAI PARSER — handles n/a pattern, ignores ungraded labs
function parseSakai() {
  let text = document.getElementById("sakaiText").value;
  if (!text.trim()) return alert("Please paste your Sakai text first.");

  // clear old results first
  document.querySelectorAll('#gradeTable td[id]').forEach(td => td.textContent = '—');

  const match = text.match(/Title[\s\S]*?(?=Gateway|Accessibility Information|The Sakai Project)/i);
  const section = match ? match[0] : text;
  const lines = section.split(/\n+/);
  const scores = [];

  for (let line of lines) {
    const lower = line.toLowerCase();
    if (!(lower.startsWith("lab") || lower.includes("safety"))) continue;
    if (lower.includes("title") || lower.includes("statistics")) continue;
    if (!line.includes("n/a")) continue;

    const after = line.split(/n\/a/i)[1];
    const clean = after.replace(/highest|immediate|am|pm|,|oct|nov|dec|sep|aug|jul|jun|may|apr|mar|feb|jan|\d{4}/gi, "").trim();
    const nums = (clean.match(/\b\d+(?:\.\d+)?\b/g) || []).map(n => parseFloat(n)).filter(n => n <= 10);
    if (!nums.length) continue;
    const earned = nums[nums.length - 1];
    if (isNaN(earned)) continue;
    const max = (lower.includes("safety") && lower.includes("quiz")) ? 10 : 2;
    scores.push({ name: line.trim(), earned, max });
  }

  if (!scores.length) return alert("No valid Sakai grades found.");
  const cat = classifyAssignments(scores);
  calculateTotals(cat);
}


document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('parseGradescopeBtn').addEventListener('click',parseGradescope);
  document.getElementById('parseSakaiBtn').addEventListener('click',parseSakai);
  document.querySelectorAll('[contenteditable="true"]').forEach(c=>c.addEventListener('input',()=>calculateTotals()));
});
</script>
