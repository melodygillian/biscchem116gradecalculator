<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grade Calculator – Gradescope + Sakai (Local CSV import)</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#000000; --muted:#222; --light:#eee; --mid:#bbb; --accent:#000; --ok:#000; --warn:#000;
    }
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--fg);}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:20px;margin:24px 0 8px}
    p{line-height:1.5}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{border:1px solid #000;padding:16px;border-radius:14px;background:#fff;flex:1 1 320px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button, input[type="file"]::file-selector-button{background:#000;color:#fff;border:1px solid #000;border-radius:9999px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.ghost{background:#fff;color:#000}
    button.link{background:transparent;border:none;text-decoration:underline;padding:0}
    button:disabled{opacity:.35;cursor:not-allowed}
    input, select{border:1px solid #000;border-radius:10px;padding:8px 10px;background:#fff;color:#000}
    input[type="number"]{width:7rem}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #000;padding:8px 6px;text-align:left;vertical-align:middle}
    th{white-space:nowrap}
    .pill{border:1px solid #000;border-radius:999px;padding:2px 10px;font-size:12px;display:inline-block}
    .muted{color:#000;opacity:.7}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));gap:16px}
    details{border:1px solid #000;border-radius:12px;padding:10px 12px;background:#fff}
    summary{cursor:pointer;font-weight:700}
    .footer{margin-top:24px;border-top:1px solid #000;padding-top:12px;font-size:12px;color:#000}
    .tag{border:1px dashed #000;border-radius:999px;padding:2px 8px; font-size:12px}
    .inline-form{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="container">
    <h1>Grade Calculator — Gradescope + Sakai</h1>
    <p class="muted">Black &amp; white, privacy‑friendly. No logins. Import your CSV exports locally, map items to your grading categories, and get your current overall grade. Nothing leaves your browser.</p>

    <div class="row">
      <section class="card" style="flex:1 1 380px">
        <h2>1) Define grading categories</h2>
        <form id="catForm" class="inline-form" onsubmit="return false;">
          <input id="catName" placeholder="Category name (e.g., Labs)" required />
          <label class="nowrap">Weight % <input id="catWeight" type="number" min="0" max="100" step="0.1" required /></label>
          <button id="addCatBtn">Add</button>
          <button class="ghost" id="resetCatsBtn" type="button">Reset</button>
        </form>
        <table id="catTable" style="margin-top:10px">
          <thead>
            <tr><th>Category</th><th>Weight %</th><th>Items</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><th class="nowrap">Total weights</th><th id="weightTotal">0%</th><th colspan="2" class="muted">Should sum to 100%</th></tr>
          </tfoot>
        </table>
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="checkbox" id="normalizeBox"/> Normalize weights to only counted categories (optional)</label>
      </section>

      <section class="card" style="flex:1 1 380px">
        <h2>2) Import assignments</h2>
        <div class="toolbar">
          <label class="pill">Gradescope CSV <input type="file" id="gradescopeFile" accept=".csv" hidden /></label>
          <label class="pill">Sakai CSV <input type="file" id="sakaiFile" accept=".csv" hidden /></label>
          <button class="ghost" id="addManualBtn" type="button">Add manual item</button>
          <button class="ghost" id="saveBtn" type="button">Save</button>
          <button class="ghost" id="loadBtn" type="button">Load</button>
          <button class="ghost" id="exportBtn" type="button">Export JSON</button>
          <input id="importJson" type="file" accept="application/json" hidden>
          <label for="importJson" class="pill">Import JSON</label>
        </div>
        <details style="margin-top:8px">
          <summary>Where do I get CSVs?</summary>
          <ul>
            <li><b>Gradescope:</b> Course &rarr; <i>Grades</i> &rarr; <i>Export</i> &rarr; CSV (per‑student or gradebook). For this tool, a CSV with columns like <span class="mono">Assignment, Score, Max</span> is ideal.</li>
            <li><b>Sakai:</b> Gradebook &rarr; <i>Export as CSV</i>.</li>
          </ul>
          <p>Exact schemas vary by campus. This tool attempts to auto‑detect common columns. You can always edit items after import.</p>
        </details>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>3) Map items to categories</h2>
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Source</th><th>Assignment</th><th>Earned</th><th>Max</th><th>Category</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>4) Results</h2>
      <div class="grid">
        <div>
          <p><b>Overall grade (so far):</b></p>
          <p style="font-size:40px;margin:4px 0"><span id="overallPct">—</span></p>
          <p class="muted">Computed as sum over categories of (average % in category) × (category weight).</p>
        </div>
        <div>
          <table id="byCatTable">
            <thead><tr><th>Category</th><th>Avg %</th><th>Weight</th><th>Weighted</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <details style="margin-top:16px">
      <summary>Notes & privacy</summary>
      <ul>
        <li>This is a static page. No servers. Your data stays in your browser (and in the JSON file if you export).</li>
        <li>Direct linking to Gradescope/Sakai would require institutional APIs + OAuth and a backend. This file uses CSV imports instead, which is safer and portable.</li>
        <li>If category weights don’t sum to 100%, we’ll warn you. You can also toggle <i>Normalize</i> to scale weights to the categories that currently have data.</li>
      </ul>
    </details>

    <div class="footer">© You. MIT/Wellesley student project. Black &amp; white for clean printing. v1.0</div>
  </div>

  <script>
    // ---------- State ----------
    const state = {
      categories: [], // {id, name, weight}
      items: [],      // {id, src, name, earned, max, catId}
      normalize:false
    };

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // ---------- Util ----------
    const uid = () => Math.random().toString(36).slice(2,10);

    function round2(n){return (Math.round((Number(n)||0)*100)/100).toFixed(2)}

    function textCSVParse(str){
      // A tiny CSV parser that handles quotes and commas.
      const rows = [];
      let cur = '', inQ = false; const out = [];
      for(let i=0;i<str.length;i++){
        const c=str[i], n=str[i+1];
        if(c==='"'){
          if(inQ && n==='"'){cur+='"'; i++;}
          else inQ = !inQ;
        } else if(c===',' && !inQ){ out.push(cur); cur=''; }
        else if((c==='\n' || c==='\r') && !inQ){
          if(cur!=='' || out.length){ out.push(cur); rows.push(out.slice()); out.length=0; cur=''; }
        } else cur+=c;
      }
      if(cur!=='' || out.length){ out.push(cur); rows.push(out); }
      return rows.filter(r=>r.length && r.some(x=>x.trim()!==''));
    }

    function pickColumnIdx(header, candidates){
      const lower = header.map(h=>h.toLowerCase().trim());
      for(const name of candidates){
        const i = lower.indexOf(name);
        if(i!==-1) return i;
      }
      // fuzzy search
      for(let i=0;i<lower.length;i++){
        const h=lower[i];
        if(candidates.some(c=>h.includes(c))) return i;
      }
      return -1;
    }

    function parseGenericCSV(text, srcLabel){
      const rows = textCSVParse(text);
      if(!rows.length) return [];
      const header = rows[0];
      const nameIdx = pickColumnIdx(header,["assignment","item","name","title"]);
      const scoreIdx = pickColumnIdx(header,["score","points","earned","grade"]);
      const maxIdx = pickColumnIdx(header,["max","out of","possible","total"]);
      const out=[];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        const name = nameIdx>-1? row[nameIdx] : (row[0]||"Untitled");
        const earnedRaw = scoreIdx>-1? row[scoreIdx] : '';
        const maxRaw = maxIdx>-1? row[maxIdx] : '';
        const earned = Number(String(earnedRaw).replace(/[^0-9.\-]/g,'')) || 0;
        const max = Number(String(maxRaw).replace(/[^0-9.\-]/g,'')) || 100;
        out.push({id:uid(), src:srcLabel, name, earned, max, catId:null});
      }
      return out;
    }

    // ---------- Category UI ----------
    const catTableBody = $("#catTable tbody");
    const weightTotalEl = $("#weightTotal");

    function renderCats(){
      catTableBody.innerHTML = '';
      let total = 0, counts={};
      state.categories.forEach(c=>counts[c.id]=0);
      state.items.forEach(it=>{ if(it.catId) counts[it.catId] = (counts[it.catId]||0)+1; });
      for(const c of state.categories){
        total += Number(c.weight)||0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td>
          <td><input type="number" min="0" max="100" step="0.1" value="${c.weight}" data-id="${c.id}" class="catWeightInput"></td>
          <td>${counts[c.id]||0}</td>
          <td><button data-id="${c.id}" class="link delCat">remove</button></td>`;
        catTableBody.appendChild(tr);
      }
      weightTotalEl.textContent = round2(total) + '%';
      if(Math.abs(total-100)>0.01 && !state.normalize){ weightTotalEl.style.color = '#a00'; weightTotalEl.title='Weights do not sum to 100%'; }
      else { weightTotalEl.style.color = '#000'; weightTotalEl.title=''; }
      renderItems();
      renderByCat();
      saveLocal();
    }

    $("#addCatBtn").addEventListener('click',()=>{
      const name = $("#catName").value.trim();
      const w = Number($("#catWeight").value);
      if(!name) return alert('Enter a category name');
      if(isNaN(w)) return alert('Enter a numeric weight');
      state.categories.push({id:uid(), name, weight:w});
      $("#catName").value=''; $("#catWeight").value='';
      renderCats();
    });

    $("#catTable").addEventListener('input', (e)=>{
      if(e.target.classList.contains('catWeightInput')){
        const id=e.target.dataset.id; const v=Number(e.target.value)||0;
        const cat=state.categories.find(c=>c.id===id); if(cat){cat.weight=v; renderCats();}
      }
    });

    $("#catTable").addEventListener('click', (e)=>{
      if(e.target.classList.contains('delCat')){
        const id=e.target.dataset.id;
        state.items.forEach(it=>{ if(it.catId===id) it.catId=null; });
        const i=state.categories.findIndex(c=>c.id===id); if(i>-1) state.categories.splice(i,1);
        renderCats();
      }
    });

    $("#resetCatsBtn").addEventListener('click',()=>{
      if(confirm('Clear all categories?')){ state.categories=[]; renderCats(); }
    });

    $("#normalizeBox").addEventListener('change',(e)=>{ state.normalize=e.target.checked; renderByCat(); });

    // ---------- Items UI ----------
    const itemsTableBody = $("#itemsTable tbody");

    function catOptionsHtml(selected){
      const opts = ['<option value="">— choose —</option>']
        .concat(state.categories.map(c=>`<option value="${c.id}" ${selected===c.id?'selected':''}>${c.name}</option>`));
      return opts.join('');
    }

    function renderItems(){
      itemsTableBody.innerHTML='';
      for(const it of state.items){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><span class="tag">${it.src}</span></td>
          <td><input value="${it.name.replaceAll('"','&quot;')}" data-id="${it.id}" class="itName"/></td>
          <td><input type="number" step="0.01" value="${it.earned}" data-id="${it.id}" class="itEarned"/></td>
          <td><input type="number" step="0.01" value="${it.max}" data-id="${it.id}" class="itMax"/></td>
          <td><select data-id="${it.id}" class="itCat">${catOptionsHtml(it.catId)}</select></td>
          <td><button class="link delItem" data-id="${it.id}">delete</button></td>`;
        itemsTableBody.appendChild(tr);
      }
      calcAndRender();
      saveLocal();
    }

    itemsTableBody.addEventListener('input',(e)=>{
      const id=e.target.dataset.id; const it=state.items.find(x=>x.id===id); if(!it) return;
      if(e.target.classList.contains('itName')) it.name=e.target.value;
      if(e.target.classList.contains('itEarned')) it.earned=Number(e.target.value)||0;
      if(e.target.classList.contains('itMax')) it.max=Number(e.target.value)||0;
      calcAndRender(); saveLocal();
    });
    itemsTableBody.addEventListener('change',(e)=>{
      if(e.target.classList.contains('itCat')){
        const id=e.target.dataset.id; const it=state.items.find(x=>x.id===id); if(it) it.catId=e.target.value||null;
        calcAndRender(); saveLocal();
      }
    });
    itemsTableBody.addEventListener('click',(e)=>{
      if(e.target.classList.contains('delItem')){
        const id=e.target.dataset.id; const i=state.items.findIndex(x=>x.id===id); if(i>-1) state.items.splice(i,1);
        renderItems();
      }
    });

    $("#addManualBtn").addEventListener('click',()=>{
      state.items.push({id:uid(), src:'Manual', name:'New item', earned:0, max:100, catId:null});
      renderItems();
    });

    // ---------- Import / Export ----------
    function readFile(file){
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(file); });
    }

    $("#gradescopeFile").addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const text = await readFile(f);
      const items = parseGenericCSV(text,'Gradescope');
      state.items.push(...items); renderItems(); e.target.value='';
    });

    $("#sakaiFile").addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const text = await readFile(f);
      const items = parseGenericCSV(text,'Sakai');
      state.items.push(...items); renderItems(); e.target.value='';
    });

    $("#exportBtn").addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(state)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='grade-calculator-data.json'; a.click();
    });

    $("#importJson").addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      try{
        const text=await readFile(f); const obj=JSON.parse(text);
        state.categories = Array.isArray(obj.categories)? obj.categories : [];
        state.items = Array.isArray(obj.items)? obj.items : [];
        state.normalize = !!obj.normalize; $("#normalizeBox").checked=state.normalize;
        renderCats(); renderItems();
      }catch(err){ alert('Invalid JSON'); }
      e.target.value='';
    });

    function saveLocal(){ localStorage.setItem('gradecalc_v1', JSON.stringify(state)); }
    function loadLocal(){ try{ const s=JSON.parse(localStorage.getItem('gradecalc_v1')||'{}'); if(s.categories) state.categories=s.categories; if(s.items) state.items=s.items; state.normalize=!!s.normalize; $("#normalizeBox").checked=state.normalize; }catch{} }

    $("#saveBtn").addEventListener('click', saveLocal);
    $("#loadBtn").addEventListener('click', ()=>{ loadLocal(); renderCats(); renderItems(); });

    // ---------- Calculation ----------
    const overallEl = $("#overallPct");
    const byCatBody = $("#byCatTable tbody");

    function calcAndRender(){
      const catStats = state.categories.map(c=>({cat:c, sumEarned:0, sumMax:0}));
      for(const it of state.items){
        if(!it.catId) continue;
        const st = catStats.find(x=>x.cat.id===it.catId); if(!st) continue;
        if(it.max>0){ st.sumEarned += Number(it.earned)||0; st.sumMax += Number(it.max)||0; }
      }
      let weightSum = 0, weightedTotal = 0;
      let activeCats = catStats.filter(s=>s.sumMax>0);
      const weightDenom = state.normalize && activeCats.length>0 ? activeCats.reduce((a,s)=>a + (Number(s.cat.weight)||0),0) : 100;

      byCatBody.innerHTML='';
      for(const s of catStats){
        const avg = s.sumMax>0 ? (s.sumEarned/s.sumMax)*100 : NaN;
        const w = Number(s.cat.weight)||0;
        const wUsed = state.normalize && activeCats.some(a=>a.cat.id===s.cat.id) ? (w / weightDenom) * 100 : w; // if normalize, rescale to 100
        const weighted = isNaN(avg) ? 0 : (avg/100) * wUsed;
        weightSum += wUsed; weightedTotal += weighted;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${s.cat.name}</td><td>${isNaN(avg)?'—':round2(avg)+'%'}</td><td>${round2(wUsed)}%</td><td>${isNaN(avg)?'—':round2(weighted)+'%'}</td>`;
        byCatBody.appendChild(tr);
      }
      overallEl.textContent = (weightedTotal>0? round2(weightedTotal)+'%':'—');
    }

    // ---------- Init ----------
    loadLocal();
    renderCats();
    renderItems();
  </script>
</body>
</html>
